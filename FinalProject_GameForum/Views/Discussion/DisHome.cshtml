@model FinalProject_GameForum.Models.Discussion

<link rel="stylesheet" href="~/css/Discussion/DisHome.css" asp-append-version="true" />
@{
	Layout = "~/Views/Shared/_LayoutDis2.cshtml";
}
<div id="main-content">
	<div class="dis-container">
		<img src="~/img/home/@(Model.ImageUrl ?? "default.jpg")" />
		<h3>@Model.DiscussionName</h3>
		<h4>@Model.DiscussionDescription</h4>

		<br />

		<h3>熱門文章</h3>
		<div class="hot-dis">
			<ul>
				<li>
					<h5>【攻略】畫面卡住 重新開機 閃退 [可能可行]的解決方法</h5>
					<h6>...<a href="#">繼續閱讀</a></h6>
				</li>
				<li>
					<h5>【討論】荒野太刀</h5>
					<h6>...<a href="#">繼續閱讀</a></h6>
				</li>
				<li>
					<h5>【密技】釣大魚成就跟帶卵魚刷法</h5>
					<h6>...<a href="#">繼續閱讀</a></h6>
				</li>
			</ul>
		</div>

		<h3>公告</h3>
		<h4>
			歡迎來到 @Model.DiscussionName 哈拉板<br />
			這裡是討論 @Model.DiscussionName 相關內容的專屬空間！
		</h4>
	</div>
</div>

<!-- 文章列表頁面 -->
<div id="article-list-container" style="display: none;">
	<div class="container mt-3">

		<!-- 分頁和分類按鈕容器 -->
		<div class="d-flex justify-content-between align-items-center mt-3">
			<!-- 分類按鈕 -->
			<div>
				<button class="btn btn-primary me-2 category-btn" data-category="">全部</button>
				<button class="btn btn-outline-primary me-2 category-btn" data-category="情報">情報</button>
				<button class="btn btn-outline-primary me-2 category-btn" data-category="攻略">攻略</button>
				<button class="btn btn-outline-primary me-2 category-btn" data-category="討論">討論</button>
				<button class="btn btn-outline-primary me-2 category-btn" data-category="心情">心情</button>
				<button class="btn btn-outline-primary category-btn" data-category="問題">問題</button>
			</div>


			<!-- 分頁按鈕 -->
			<div>
				<button class="btn btn-outline-secondary">« Previous</button>
				<button class="btn btn-outline-secondary">Next »</button>
			</div>
		</div>

		<!-- 文章列表 -->
		<div id="articleList"></div>

		<!-- 右側聊天室 -->
		<div class="chatroom position-fixed end-0 top-50 translate-middle-y bg-white p-3">
			<h5 class="text-center"><strong>聊天室</strong></h5>

			<div id="chatRoom" class="chat-container">
				<div id="chatMessages" class="chat-messages"></div>

				<div class="chat-input">
					<input type="text" id="messageInput" placeholder="輸入訊息..." />
					<button id="sendButton">發送</button>
				</div>
			</div>
		</div>

		<!-- 聊天室 JS（SignalR.Hub、卷軸）-->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
		<script>
			var connection = new signalR.HubConnectionBuilder()
				.withUrl("/Discussion/chatHub")
				.build();

			connection.start().catch(err => console.error(err.toString()));

			document.getElementById("sendButton").addEventListener("click", function () {
				sendMessage();
			});

			document.getElementById("messageInput").addEventListener("keydown", function (event) {
				if (event.key === 'Enter') {
					event.preventDefault();
					sendMessage();
				}
			});

			function sendMessage() {
				var message = document.getElementById("messageInput").value;
				if (message.trim() !== "") {
					connection.invoke("SendMessage", message).catch(err => console.error(err.toString()));
					document.getElementById("messageInput").value = "";
				}
			}

			// 滾動到底部的函式
			function scrollToBottom() {
				let chatMessages = document.getElementById("chatMessages");
				chatMessages.scrollTop = chatMessages.scrollHeight;
			}

			// 當訊息被發送時，自動滾動到底部
			document.getElementById("sendButton").addEventListener("click", function () {
				setTimeout(scrollToBottom, 100); // 稍微延遲，確保訊息已經插入
			});

			// 如果是用 Enter 發送訊息，也觸發滾動
			document.getElementById("messageInput").addEventListener("keypress", function (event) {
				if (event.key === "Enter") {
					event.preventDefault(); // 防止換行
					document.getElementById("sendButton").click(); // 模擬點擊發送按鈕
					setTimeout(scrollToBottom, 100);
				}
			});

			// 當聊天室載入時，自動滾到底部
			document.addEventListener("DOMContentLoaded", scrollToBottom);

			// 當訊息接收時，自動滾動到底部
			connection.on("ReceiveMessage", function (user, message) {
				var chatBox = document.getElementById("chatMessages");
				var newMessage = document.createElement("div");
				newMessage.innerHTML = user + "：" + convertLinksToAnchors(message); // 使用 convertLinksToAnchors 格式化訊息
				chatBox.appendChild(newMessage);

				// 收到訊息後自動滾動到底部
				scrollToBottom();
			});

			// 將訊息中的 URL 轉換為超連結
			function convertLinksToAnchors(message) {
				var urlRegex = /(https?:\/\/[^\s]+)/g; // 正則表達式匹配 URL
				return message.replace(urlRegex, function(url) {
					return `<a href="${url}" target="_blank">${url}</a>`; // 將 URL 轉換為超連結
				});
			}
		</script>


	</div>
</div>

<!-- JavaScript 控制切換 -->
<script>
	document.addEventListener("DOMContentLoaded", function () {
		let discussionId = @Model.DiscussionId;
		let articleListContainer = document.getElementById("article-list-container");
		let mainContent = document.getElementById("main-content");

		// 監聽文章列表按鈕
		document.getElementById("article-list-btn").addEventListener("click", function (event) {
			event.preventDefault();

			mainContent.style.display = "none";
			articleListContainer.style.display = "block";

			// 預設載入所有文章（不帶 category）
			loadArticleList("");
		});

		// 監聽分類按鈕點擊
		document.querySelectorAll(".category-btn").forEach(button => {
			button.addEventListener("click", function () {
				let category = this.getAttribute("data-category");
				loadArticleList(category);
			});
		});

		// 載入文章列表（可帶入分類）
		function loadArticleList(category) {
			fetch(`/Discussion/LoadArticleList?discussionId=${discussionId}&category=${category}`)
				.then(response => response.text())
				.then(html => {
					document.getElementById("articleList").innerHTML = html;
				})
				.catch(error => console.error("載入文章列表失敗:", error));
		}
	});
</script>


